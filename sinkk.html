<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²‰æµ®å¯¦é©—å®¤ v4.0 (Fix Audio & Gaze)</title>
    <style>
        /* å…¨å±€è¨­å®š */
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #f0f0f0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§ */
        }

        /* å•Ÿå‹•é®ç½© */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        .start-instruction {
            margin-bottom: 20px;
            font-size: 24px;
            color: #ffcc00;
            max-width: 80%;
        }

        #start-btn {
            font-size: 40px;
            padding: 20px 80px;
            background-color: #4CAF50;
            color: white;
            border: 5px solid white;
            border-radius: 50px;
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        /* è¨­å®šæŒ‰éˆ• */
        #settings-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 30px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            border: 2px solid #333;
        }

        /* è¨­å®šé¢æ¿ */
        #settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #333;
            z-index: 200;
            display: none;
            width: 500px;
            text-align: center;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        
        input[type=range] {
            width: 80%;
            height: 40px;
            margin: 20px 0;
        }

        .close-settings {
            background: #2196F3;
            color: white;
            padding: 10px 40px;
            font-size: 24px;
            border: none;
            border-radius: 10px;
            margin-top: 20px;
        }

        /* å·¦é‚Šï¼šç‰©å“æ¶ */
        #shelf {
            width: 35%;
            background-color: #ffe0b2;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 15px;
            padding: 20px;
            padding-top: 80px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* ç‰©å“å®¹å™¨ */
        .item-wrapper {
            position: relative;
            width: 100%;
            height: 160px;
            /* é—œéµï¼šå…è¨±æ»‘é¼ äº‹ä»¶ï¼Œä½†å…§å®¹ç‰©ä¸é˜»æ“‹ */
            cursor: pointer;
        }

        /* ç‰©å“æŒ‰éˆ•å…§å®¹ */
        .item-btn {
            background-color: white;
            border: 4px solid #333;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            transition: transform 0.2s, background-color 0.2s;
            /* é—œéµï¼šè®“ JS åªåµæ¸¬å¤–å±¤ wrapperï¼Œé¿å…å­å…ƒç´ å¹²æ“¾çœ¼å‹•å„€åµæ¸¬ */
            pointer-events: none; 
        }

        /* ç•¶è¢«é¸ä¸­(Hover)æ™‚çš„æ¨£å¼ */
        .item-wrapper.hovered .item-btn {
            background-color: #fff9c4;
            transform: scale(1.02);
            border-color: #ff9800;
        }

        /* çœ¼å‹•æ³¨è¦–é€²åº¦åœˆ (SVG) */
        .dwell-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* çµ•å°ç©¿é€ */
            z-index: 5;
        }
        
        .dwell-circle {
            fill: none;
            stroke: #ff0000;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 640; /* åœ“å‘¨é•· */
            stroke-dashoffset: 640; /* åˆå§‹éš±è— */
            opacity: 0.8;
            /* å‹•ç•«ç”± JS æ§åˆ¶ */
        }

        .item-icon {
            font-size: 50px;
            margin-bottom: 5px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .item-icon img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .item-name {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        /* å³é‚Šï¼šå¯¦é©—æ°´ç®± */
        #lab-area {
            width: 65%;
            position: relative;
            background-color: #fff;
            border-left: 5px solid #333;
        }

        #air { height: 30%; background-color: #e0f7fa; }
        #water {
            height: 70%;
            background-color: #29b6f6;
            position: relative;
            border-top: 5px solid #0288d1;
            overflow: hidden;
        }

        .wave {
            position: absolute;
            top: -20px;
            left: 0;
            width: 200%;
            height: 40px;
            background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1200 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="%23e0f7fa"></path></svg>');
            background-size: 50% 100%;
            animation: wave-move 5s linear infinite;
        }
        @keyframes wave-move {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        #active-item {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            transition: top 1.5s cubic-bezier(0.45, 0, 0.55, 1);
            z-index: 10;
            display: none;
        }
        #active-item img { width: 100%; height: 100%; object-fit: contain; }

        #feedback-text {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 50px;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 0px #000;
            background-color: rgba(0,0,0,0.6);
            padding: 15px 40px;
            border-radius: 50px;
            display: none;
            width: 80%;
            text-align: center;
            pointer-events: none;
        }

        #reset-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 15px 30px;
            font-size: 24px;
            background-color: #ff5252;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            z-index: 20;
        }

        @keyframes floating {
            0% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-15px); }
            100% { transform: translateX(-50%) translateY(0px); }
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="start-overlay">
        <div class="start-instruction">
            âš ï¸ è«‹æª¢æŸ¥ iPad å´é‚ŠéœéŸ³éµå·²é—œé–‰<br>ä¸¦èª¿é«˜éŸ³é‡
        </div>
        <button id="start-btn" onclick="initGame()">é»æ“Šé–‹å§‹éŠæˆ²</button>
    </div>

    <div id="settings-icon" onclick="toggleSettings()">âš™ï¸</div>

    <div id="settings-modal">
        <h2>çœ¼å‹•æ³¨è¦–æ™‚é–“è¨­å®š</h2>
        <div style="font-size: 60px; font-weight: bold; color: #0288d1;" id="time-display">1.0 ç§’</div>
        <input type="range" id="dwell-slider" min="100" max="1500" step="100" value="1000" oninput="updateDwellSettings(this.value)">
        <br>
        <button class="close-settings" onclick="speakTest()">ğŸ”Š æ¸¬è©¦è²éŸ³</button>
        <button class="close-settings" onclick="toggleSettings()">å®Œæˆ</button>
    </div>

    <div id="shelf">
        <div class="item-wrapper" data-key="bottle" data-type="float">
            <div class="item-btn"><div class="item-icon">ğŸ§´</div><div class="item-name">æ°´æ¨½ (ç©º)</div></div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>
        
        <div class="item-wrapper" data-key="sponge" data-type="float">
            <div class="item-btn"><div class="item-icon">ğŸ§½</div><div class="item-name">æµ·ç¶¿</div></div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>

        <div class="item-wrapper" data-key="apple" data-type="float">
            <div class="item-btn"><div class="item-icon">ğŸ</div><div class="item-name">è˜‹æœ</div></div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>

        <div class="item-wrapper" data-key="magnet" data-type="sink">
            <div class="item-btn"><div class="item-icon">ğŸ§²</div><div class="item-name">ç£éµ</div></div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>

        <div class="item-wrapper" data-key="pingpong" data-type="float">
            <div class="item-btn"><div class="item-icon">âšª</div><div class="item-name">å…µå…µçƒ</div></div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>

        <div class="item-wrapper" data-key="doraemon" data-type="sink">
            <div class="item-btn">
                <div class="item-icon"><img src="https://placehold.co/200x200/00a0e9/ffffff?text=Doraemon" alt="å¤šå•¦Aå¤¢"></div>
                <div class="item-name">å¤šå•¦Aå¤¢</div>
            </div>
            <svg class="dwell-svg" viewBox="0 0 200 160"><rect class="dwell-circle" x="10" y="10" width="180" height="140" rx="20" ry="20"></rect></svg>
        </div>
    </div>

    <div id="lab-area">
        <button id="reset-btn" onclick="resetLab()">æ¸…ç©ºæ°´ç®±</button>
        <div id="air"></div>
        <div id="water"><div class="wave"></div></div>
        <div id="active-item"></div>
        <div id="feedback-text"></div>
    </div>

    <script>
        // è¨­å®š
        const icons = {
            'bottle': 'ğŸ§´',
            'sponge': 'ğŸ§½',
            'apple': 'ğŸ',
            'magnet': 'ğŸ§²',
            'pingpong': 'âšª',
            'doraemon': '<img src="https://placehold.co/200x200/00a0e9/ffffff?text=Doraemon" alt="å¤šå•¦Aå¤¢">' 
        };

        let dwellTime = 1000;
        let dwellTimer = null;
        let leaveTimer = null; // å®¹éŒ¯è¨ˆæ™‚å™¨
        let isAnimating = false;
        let audioContext = null;
        let currentVoice = null;

        // 1. åˆå§‹åŒ–éŠæˆ²èˆ‡è²éŸ³ (Audio Unlock)
        function initGame() {
            // åˆå§‹åŒ–èªéŸ³ (å¼·åˆ¶ iOS å–šé†’èªéŸ³å¼•æ“)
            const voices = window.speechSynthesis.getVoices();
            currentVoice = voices.find(v => v.lang === 'zh-HK') || voices.find(v => v.lang.includes('zh'));
            
            // æ’­æ”¾ä¸€æ®µç„¡è²èªªè©±ä¾†è§£é– TTS
            const utter = new SpeechSynthesisUtterance("æº–å‚™å¥½");
            utter.rate = 1.0; 
            utter.volume = 1.0;
            if(currentVoice) utter.voice = currentVoice;
            window.speechSynthesis.speak(utter);

            // åˆå§‹åŒ– AudioContext (è§£é– Web Audio)
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
            
            // æ’­æ”¾ç„¡è²éŸ³é »
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            gain.gain.value = 0;
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start(0);
            osc.stop(0.1);

            document.getElementById('start-overlay').style.display = 'none';
        }

        // 2. è™•ç†çœ¼å‹•/æ»‘é¼ é‚è¼¯ (åŠ å…¥å®¹éŒ¯)
        const items = document.querySelectorAll('.item-wrapper');
        
        items.forEach(item => {
            // é€²å…¥å€åŸŸ
            item.addEventListener('mouseenter', () => {
                if (isAnimating) return;
                
                // å¦‚æœæ˜¯å‰›é›¢é–‹åˆé¦¬ä¸Šå›ä¾† (çœ¼å‹•å„€æŠ–å‹•)ï¼Œå–æ¶ˆé›¢é–‹è¨ˆæ™‚
                if (leaveTimer) {
                    clearTimeout(leaveTimer);
                    leaveTimer = null;
                    return; // ç¹¼çºŒåŸæœ¬çš„è¨ˆæ™‚ï¼Œä¸é‡ç½®
                }

                // è¦–è¦ºå›é¥‹
                item.classList.add('hovered');
                const circle = item.querySelector('.dwell-circle');
                
                // é–‹å§‹å€’æ•¸
                circle.style.transition = `stroke-dashoffset ${dwellTime}ms linear`;
                setTimeout(() => { circle.style.strokeDashoffset = '0'; }, 10);

                dwellTimer = setTimeout(() => {
                    // æ™‚é–“åˆ°ï¼Œè§¸ç™¼ï¼
                    const key = item.dataset.key;
                    const type = item.dataset.type;
                    triggerAction(key, type);
                    clearDwell(item);
                }, dwellTime);
            });

            // é›¢é–‹å€åŸŸ
            item.addEventListener('mouseleave', () => {
                // è¨­å®šä¸€å€‹çŸ­æš«çš„ç·©è¡ (0.1ç§’)ï¼Œé˜²æ­¢çœ¼å‹•å„€å› æŠ–å‹•è€Œå°è‡´åˆ¤å®šå¤±æ•ˆ
                leaveTimer = setTimeout(() => {
                    clearDwell(item);
                    leaveTimer = null;
                }, 100); 
            });
            
            // é»æ“Š (è§¸æ§æˆ–æ‰‹å‹•)
            item.addEventListener('click', () => {
                if (isAnimating) return;
                const key = item.dataset.key;
                const type = item.dataset.type;
                clearDwell(item);
                triggerAction(key, type);
            });
        });

        function clearDwell(item) {
            if (dwellTimer) {
                clearTimeout(dwellTimer);
                dwellTimer = null;
            }
            item.classList.remove('hovered');
            const circle = item.querySelector('.dwell-circle');
            circle.style.transition = 'none'; 
            circle.style.strokeDashoffset = '640'; 
        }

        // 3. è§¸ç™¼å¯¦é©—
        function triggerAction(key, type) {
            if (isAnimating) return;
            startExperiment(key, type);
        }

        // è²æ•ˆæ’­æ”¾
        function playSplashSound() {
            if (!audioContext) return;
            if (audioContext.state === 'suspended') audioContext.resume();

            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, audioContext.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        }

        function speak(text) {
            // å–æ¶ˆèˆŠçš„ç™¼éŸ³
            window.speechSynthesis.cancel(); 
            const utterThis = new SpeechSynthesisUtterance(text);
            if (currentVoice) utterThis.voice = currentVoice;
            utterThis.rate = 0.9;
            window.speechSynthesis.speak(utterThis);
        }
        
        function speakTest() {
            playSplashSound();
            speak("æ¸¬è©¦è²éŸ³");
        }

        // è¨­å®šæ§åˆ¶
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }
        function updateDwellSettings(val) {
            dwellTime = parseInt(val);
            document.getElementById('time-display').innerText = (dwellTime / 1000).toFixed(1) + " ç§’";
        }

        // å¯¦é©—å‹•ç•«é‚è¼¯
        const activeItem = document.getElementById('active-item');
        const feedbackText = document.getElementById('feedback-text');

        function startExperiment(itemKey, type) {
            isAnimating = true;
            resetLab(false);

            activeItem.innerHTML = icons[itemKey];
            activeItem.style.display = 'flex';
            activeItem.style.animation = 'none';
            activeItem.style.top = '5%'; 

            setTimeout(() => {
                if (type === 'float') {
                    activeItem.style.top = '25%'; 
                    setTimeout(() => playSplashSound(), 500);
                    setTimeout(() => {
                        activeItem.style.animation = 'floating 2s ease-in-out infinite';
                        showFeedback('æµ®æ°´ä¸Š');
                        isAnimating = false;
                    }, 1500); 
                } else {
                    activeItem.style.top = '82%';
                    setTimeout(() => playSplashSound(), 400); 
                    setTimeout(() => {
                        showFeedback('æ²‰å·¦å•¦');
                        isAnimating = false;
                    }, 1500);
                }
            }, 500);
        }

        function showFeedback(text) {
            feedbackText.innerText = text;
            feedbackText.style.display = 'block';
            speak(text);
        }

        function resetLab(fully = true) {
            if(fully) isAnimating = false;
            activeItem.style.display = 'none';
            activeItem.style.top = '5%';
            activeItem.style.animation = 'none';
            feedbackText.style.display = 'none';
            // ä¸è¦åœ¨é‡ç½®æ™‚ cancel èªéŸ³ï¼Œä»¥å…æˆªæ–·å›é¥‹
        }
    </script>
</body>
</html>